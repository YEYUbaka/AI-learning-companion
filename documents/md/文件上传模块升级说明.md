# 📚 文件上传与解析模块升级说明

## ✅ 升级完成

已成功升级文件上传与解析模块，新增支持 **DOCX** 和 **PPTX** 格式。

---

## 📋 支持的文件格式

| 格式 | 扩展名 | 状态 | 说明 |
|------|--------|------|------|
| PDF | `.pdf` | ✅ 已有 | 使用 PyMuPDF 解析 |
| 文本 | `.txt`, `.md`, `.markdown` | ✅ 已有 | 自动检测编码 |
| Word | `.docx` | 🆕 新增 | 使用 python-docx 解析 |
| PowerPoint | `.pptx` | 🆕 新增 | 使用 python-pptx 解析 |

---

## 🔧 安装依赖

在 `backend` 目录下运行：

```powershell
cd backend
.\venv\Scripts\activate
pip install python-docx python-pptx
```

或者安装所有依赖：

```powershell
pip install -r requirements.txt
```

新增的依赖包：
- `python-docx>=1.1.0` - Word 文档解析
- `python-pptx>=0.6.23` - PowerPoint 文档解析

---

## 🎯 功能特点

### 1. 自动文件类型识别

系统会根据文件扩展名自动选择对应的解析函数：
- `.pdf` → `parse_pdf()`
- `.txt`, `.md` → `parse_text_file()`
- `.docx` → `parse_docx()`
- `.pptx` → `parse_pptx()`

### 2. 智能文本提取

**DOCX 解析**：
- 提取所有段落文本
- 提取表格中的文本内容
- 自动过滤空内容

**PPTX 解析**：
- 遍历所有幻灯片
- 提取所有形状中的文本
- 自动过滤空内容

### 3. 大文件自动截断

- **最大提取长度**: 8000 字符
- **截断长度**: 6000 字符
- **目的**: 防止 AI 调用时 Token 过多

当文件文本超过 8000 字符时，系统会自动截断到 6000 字符，并在日志中记录。

### 4. 完整的错误处理

- ✅ 不支持的文件类型 → HTTP 400
- ✅ 文件内容为空 → HTTP 400
- ✅ 解析失败 → HTTP 400/500（根据错误类型）
- ✅ 文件过大 → HTTP 400
- ✅ 自动清理失败的上传文件

### 5. 日志记录

系统会在后端控制台输出：
- `[INFO] 文件解析成功: 文件名, 提取文本长度: X 字符`
- `[INFO] 文件文本已截断: 原始长度 -> 截断后长度 字符`
- `[ERROR] 文件解析异常: 文件名, 错误: 错误信息`

---

## 📝 API 接口

### POST `/api/v1/files/upload`

**请求**:
- Content-Type: `multipart/form-data`
- 参数: `file` (文件)

**响应**:
```json
{
  "success": true,
  "file_name": "example.docx",
  "file_path": "uploads/example.docx",
  "file_size": 12345,
  "text_length": 5678,
  "text_preview": "文件内容预览...",
  "message": "文件上传并解析成功"
}
```

**错误响应**:
```json
{
  "detail": "文件解析失败: 不支持的文件类型: .xlsx"
}
```

---

## 🧪 测试建议

### 测试用例

| 文件类型 | 测试文件 | 期望结果 |
|---------|---------|---------|
| PDF | `test.pdf` | `text_length > 1000` |
| DOCX | `test.docx` | `text_length > 500` |
| PPTX | `test.pptx` | `text_length > 200` |
| TXT | `test.txt` | `text_length > 100` |

### 测试步骤

1. **启动后端服务**
   ```powershell
   cd backend
   .\venv\Scripts\activate
   uvicorn main:app --reload --port 8000
   ```

2. **访问 Swagger 文档**
   - 打开: http://127.0.0.1:8000/docs
   - 找到 `/api/v1/files/upload` 接口
   - 点击 "Try it out"
   - 选择文件并上传

3. **或使用前端页面**
   - 访问: http://localhost:5173/upload-file
   - 选择文件上传
   - 查看解析结果

---

## 🔍 代码结构

### 后端文件

```
backend/
├── utils/
│   └── file_parser.py          # 文件解析工具（已更新）
├── routers/
│   └── files.py                # 文件上传路由（已更新）
└── requirements.txt            # 依赖列表（已更新）
```

### 主要函数

**`parse_file(file_path: str) -> tuple[str, int]`**
- 主入口函数
- 自动识别文件类型
- 调用对应的解析函数
- 处理文本截断
- 返回文本内容和长度

**`parse_docx(file_path: str) -> str`**
- 解析 Word 文档
- 提取段落和表格文本

**`parse_pptx(file_path: str) -> str`**
- 解析 PowerPoint 文档
- 提取所有幻灯片中的文本

---

## ⚠️ 注意事项

1. **文件大小限制**: 最大 10MB
2. **文本长度限制**: 超过 8000 字符会自动截断到 6000
3. **空文件处理**: 如果文件内容为空，会返回错误
4. **编码问题**: TXT 文件会自动检测编码，支持 UTF-8、GBK 等
5. **依赖安装**: 确保已安装所有必需的 Python 包

---

## 🐛 常见问题

### 1. 导入错误

**错误**: `ImportError: No module named 'docx'`

**解决**: 
```powershell
pip install python-docx python-pptx
```

### 2. DOCX 解析失败

**可能原因**:
- 文件损坏
- 文件不是真正的 DOCX 格式（可能是 DOC 格式）

**解决**: 确保文件是 `.docx` 格式（不是 `.doc`）

### 3. PPTX 解析失败

**可能原因**:
- 文件损坏
- 文件不是真正的 PPTX 格式（可能是 PPT 格式）

**解决**: 确保文件是 `.pptx` 格式（不是 `.ppt`）

### 4. 文本提取为空

**可能原因**:
- 文件是图片或扫描件（PDF）
- 文件内容确实是空的
- 文件格式不支持

**解决**: 检查文件内容，确保有可提取的文本

---

## 🚀 后续优化建议

1. **支持更多格式**:
   - `.xlsx` (Excel)
   - `.epub` (电子书)
   - `.html` (网页)

2. **OCR 功能**:
   - 支持扫描件 PDF 的 OCR 识别
   - 支持图片中的文字识别

3. **批量上传**:
   - 支持一次上传多个文件
   - 批量解析和处理

4. **文件预览**:
   - 在前端显示提取的文本预览
   - 支持编辑和修改

---

**升级完成！现在可以上传 Word 和 PowerPoint 文件了！** 🎉


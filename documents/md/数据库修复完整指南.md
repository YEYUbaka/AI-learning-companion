# 🔧 数据库连接修复完整指南

## 当前问题

虽然你能用 `sqlcmd -S localhost -U sa -P 123456` 连接，但 SQLAlchemy 报错。

## 🎯 解决步骤

### 步骤 1：创建数据库（在你自己能正常连接的终端执行）

```powershell
sqlcmd -S localhost -U sa -P 123456 -Q "CREATE DATABASE ZhixueBan"
```

如果数据库已存在，会提示错误但不影响。

### 步骤 2：检查 ODBC 驱动

```powershell
odbcinst -q -d
```

查找是否有以下驱动之一：
- `ODBC Driver 17 for SQL Server` ✅ 推荐
- `SQL Server` 
- `SQL Server Native Client 11.0`

### 步骤 3：已更新的配置

我已经更新了 `backend/database.py`：
- ✅ 添加端口号 `:1433`
- ✅ 使用 `ODBC Driver 17 for SQL Server`
- ✅ 添加加密配置

### 步骤 4：如果没有 ODBC Driver 17

#### 选项 A：使用 SQL Server 驱动（推荐）

修改 `backend/database.py` 第12行：

```python
SQLALCHEMY_DATABASE_URL = (
    "mssql+pyodbc://sa:123456@localhost:1433/ZhixueBan"
    "?driver=SQL+Server"                    # 改为这个
    "&Trusted_Connection=no"
    "&Encrypt=yes"
    "&TrustServerCertificate=yes"
)
```

#### 选项 B：安装 ODBC Driver 17

下载并安装：
https://aka.ms/downloadmsodbcsql

### 步骤 5：重启后端

```powershell
cd "F:\Cursor projects\Web\backend"
.\启动.bat
```

### 步骤 6：验证

查看后端启动日志：

**成功标志**：
```
✅ 数据库表创建成功
```

**如果还是失败**，查看具体错误信息。

## 📋 常见错误解决方案

### 错误 1：找不到驱动

**解决方法**：使用 `SQL Server` 驱动（选项 A 上面）

### 错误 2：连接到失败的服务器

**解决方法**：
1. 检查 SQL Server 服务是否运行
2. 检查防火墙设置
3. 尝试使用 `127.0.0.1` 代替 `localhost`

### 错误 3：登录失败

**解决方法**：
1. 确认用户名密码正确
2. 确认 SQL Server 启用混合模式登录

## 🔄 替代方案：使用 SQLite（如果 SQL Server 太麻烦）

如果 SQL Server 配置困难，可以快速切换到 SQLite：

### 修改 database.py

```python
SQLALCHEMY_DATABASE_URL = "sqlite:///./zhixueban.db"
```

### 安装 SQLite 支持

```powershell
cd backend
venv\Scripts\activate
pip install pysqlite3
```

### 重启后端

这样可以避开 SQL Server 配置问题。

## 📝 快速检查清单

- [ ] 创建数据库 `zsBan`
- [ ] 检查 ODBC 驱动
- [ ] 更新 database.py 配置
- [ ] 重启后端服务
- [ ] 验证是否成功

---

**现在执行步骤1创建数据库，然后重启后端！**


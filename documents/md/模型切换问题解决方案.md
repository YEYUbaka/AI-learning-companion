# 🔧 模型切换问题解决方案

## 问题现象
前端正确发送了provider参数（moonshot），但后端还是使用DeepSeek回答

## 🔍 可能的原因

### 1. API密钥未配置（最可能）
如果选择moonshot，但`.env`文件中没有配置`MOONSHOT_API_KEY`，系统会：
- 检测到API密钥缺失
- 可能回退到默认模型（DeepSeek）
- 或者显示错误信息

### 2. 后端没有正确接收provider参数
虽然前端发送了，但后端可能没有正确解析

### 3. API调用失败
即使配置了密钥，API调用失败也可能导致回退

## ✅ 解决方案

### 步骤1：检查.env文件配置

打开 `backend/.env` 文件，确保配置了Moonshot的API密钥：

```ini
# Moonshot API 配置
MOONSHOT_API_KEY=你的moonshot_api_key_here
MOONSHOT_API_BASE_URL=https://api.moonshot.cn/v1
MOONSHOT_MODEL=moonshot-v1-8k
```

**重要**：将 `你的moonshot_api_key_here` 替换为你的真实API密钥！

### 步骤2：重启后端服务

修改`.env`文件后，**必须重启后端服务**：
1. 在后端PowerShell窗口按 `Ctrl+C` 停止服务
2. 重新运行 `.\start.bat`

### 步骤3：查看后端日志

重启后，在前端选择moonshot并发送问题，查看后端窗口应该看到：

```
[DEBUG] 收到请求 - prompt: ..., provider: moonshot
[DEBUG] 使用模型提供商: moonshot
[DEBUG] 最终使用的provider: moonshot
[DEBUG] 调用模型 - Provider: Moonshot, Base URL: https://api.moonshot.cn/v1, Model: moonshot-v1-8k
```

### 步骤4：检查错误信息

如果看到：
```
[ERROR] 错误：未配置 MOONSHOT_API_KEY，请在 .env 文件中设置
```

说明API密钥未配置，需要在`.env`文件中添加。

## 🧪 测试步骤

1. **配置API密钥**：
   - 编辑 `backend/.env` 文件
   - 添加 `MOONSHOT_API_KEY=你的密钥`

2. **重启后端**：
   - 停止后端服务（Ctrl+C）
   - 重新启动（`.\start.bat`）

3. **测试切换**：
   - 在前端选择"Moonshot"
   - 发送一个问题
   - 查看后端日志

4. **验证结果**：
   - 后端日志应该显示使用Moonshot
   - AI回答应该来自Moonshot模型

## 📝 完整配置示例

假设你已经准备好了Moonshot的API密钥，`.env`文件应该包含：

```ini
# 你当前的DeepSeek配置（保持不变）
AI_API_KEY=sk-hrrwzmmxydqkpitunkfonggkghnnxoshuakucxarfxczpmab
AI_API_BASE_URL=https://api.siliconflow.cn/v1
AI_MODEL=deepseek-ai/DeepSeek-V3

# Moonshot配置（添加你的真实密钥）
MOONSHOT_API_KEY=你的moonshot_api_key_here
MOONSHOT_API_BASE_URL=https://api.moonshot.cn/v1
MOONSHOT_MODEL=moonshot-v1-8k

# 其他模型配置（如果有的话）
WENXIN_API_KEY=你的文心一言密钥
XINGHUO_API_KEY=你的星火密钥
CHATGLM_API_KEY=你的ChatGLM密钥
```

## ⚠️ 重要提示

1. **API密钥格式**：
   - 不要加引号：`MOONSHOT_API_KEY=你的密钥` ✅
   - 不要有空格：`MOONSHOT_API_KEY = 你的密钥` ❌

2. **必须重启后端**：
   - 修改`.env`后必须重启
   - 前端UI切换不需要重启

3. **检查后端日志**：
   - 如果看到错误信息，说明配置有问题
   - 根据错误信息修复配置

---

**现在请：**
1. 检查`.env`文件中是否配置了`MOONSHOT_API_KEY`
2. 如果没配置，添加你的Moonshot API密钥
3. 重启后端服务
4. 再次测试切换模型

如果配置了密钥还是不行，请告诉我后端日志中显示什么错误信息。


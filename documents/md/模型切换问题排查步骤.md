# 🔍 模型切换问题排查步骤

## ✅ 已确认的配置

根据诊断脚本，所有API密钥都已正确配置：
- ✅ DeepSeek: 已配置
- ✅ Moonshot: 已配置（模型：kimi-k2-0905-preview）
- ✅ 文心一言: 已配置
- ✅ 星火: 已配置
- ✅ ChatGLM: 已配置

## 🔍 排查步骤

### 步骤1：查看后端日志

**当你在前端选择moonshot并发送问题时，后端PowerShell窗口应该显示：**

```
[DEBUG] 收到请求 - prompt: ..., provider: moonshot
[DEBUG] 路由层 - 收到provider参数: moonshot
[DEBUG] 路由层 - 准备调用ask_gpt_stream，provider=moonshot
[DEBUG] ask_gpt_stream函数 - 接收到的provider参数: moonshot
[DEBUG] ask_gpt_stream函数 - 最终使用的provider: moonshot
[DEBUG] 调用模型 - Provider: Moonshot, Base URL: https://api.moonshot.cn/v1, Model: kimi-k2-0905-preview
[DEBUG] 准备调用API - Provider: Moonshot, Model: kimi-k2-0905-preview, Base URL: https://api.moonshot.cn/v1
[DEBUG] API调用成功，开始流式返回
```

**如果看到错误：**
```
[ERROR] API调用失败 - Provider: Moonshot, Error: ...
```

说明API调用失败，需要检查：
1. API密钥是否正确
2. 模型名称是否正确
3. Base URL是否正确

### 步骤2：检查前端Network请求

1. 打开浏览器开发者工具（F12）
2. 切换到 **Network** 标签
3. 选择moonshot并发送问题
4. 找到 `/api/v1/ai/ask/stream` 请求
5. 查看 **Request Payload**，应该包含：
   ```json
   {
     "prompt": "你的问题",
     "provider": "moonshot"
   }
   ```

### 步骤3：检查前端响应

在Network标签中，查看 `/api/v1/ai/ask/stream` 的响应：
- 如果看到 `"provider": "Moonshot"`，说明后端正确使用了Moonshot
- 如果看到 `"provider": "DeepSeek"`，说明后端还是使用了DeepSeek

### 步骤4：检查前端控制台

查看浏览器控制台（Console标签）：
- 是否有错误信息？
- 是否有 `发送请求，使用模型: moonshot` 的日志？

## 🛠️ 可能的问题

### 问题1：后端没有重启

**症状**：修改代码后，后端没有自动重载

**解决**：
1. 检查后端窗口是否显示 `WARNING: WatchFiles detected changes`
2. 如果没有，手动重启后端（Ctrl+C，然后重新启动）

### 问题2：API调用失败但错误被吞掉

**症状**：后端日志显示准备调用API，但没有后续日志

**解决**：
- 现在已添加了try-catch，应该会显示错误信息
- 查看后端日志中的 `[ERROR]` 信息

### 问题3：前端缓存

**症状**：前端代码没有更新

**解决**：
1. 硬刷新浏览器（Ctrl+Shift+R 或 Ctrl+F5）
2. 清除浏览器缓存

## 📝 请提供以下信息

1. **后端日志**（最重要）：
   - 选择moonshot时，后端窗口显示什么？
   - 是否有 `[DEBUG] 最终使用的provider: moonshot`？
   - 是否有 `[ERROR]` 信息？

2. **前端Network请求**：
   - Request Payload中是否包含 `"provider": "moonshot"`？

3. **前端响应**：
   - 响应中的chunk是否包含 `"provider": "Moonshot"`？

---

**请查看后端PowerShell窗口的完整日志，并告诉我看到了什么！** 🔍

特别是：
- 是否看到 `[DEBUG] 最终使用的provider: moonshot`？
- 是否看到 `[DEBUG] 准备调用API - Provider: Moonshot`？
- 是否看到任何 `[ERROR]` 信息？


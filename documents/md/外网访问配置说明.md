# 智学伴项目 - 外网访问配置说明

## 🔍 问题原因

外网访问时显示"加载数据失败"的原因是：
1. **前端API配置硬编码**：前端API地址硬编码为 `http://127.0.0.1:8000`，外网访问时无法连接到后端
2. **后端服务绑定地址**：需要确保后端服务绑定到 `0.0.0.0` 而不是 `127.0.0.1`

## ✅ 已修复内容

### 1. 前端API自动检测（已修复）

已修改 `frontend/src/api/apiClient.js`，现在会自动检测环境：
- **开发环境**（localhost/127.0.0.1）：使用 `http://127.0.0.1:8000`
- **生产环境**（外网IP/域名）：自动使用当前访问的IP地址，后端端口8000

例如：
- 访问 `http://47.114.103.200:5173` → 后端地址自动设置为 `http://47.114.103.200:8000`
- 访问 `http://localhost:5173` → 后端地址自动设置为 `http://127.0.0.1:8000`

### 2. 后端服务绑定（已配置）

后端启动脚本 `2-启动后端服务.bat` 已配置为：
```batch
uvicorn main:app --reload --port 8000 --host 0.0.0.0
```

`--host 0.0.0.0` 确保后端服务监听所有网络接口，允许外网访问。

## 🚀 部署步骤

### 步骤1：确保后端服务正确启动

```powershell
# 运行后端启动脚本
2-启动后端服务.bat
```

**检查要点：**
- 确认启动日志显示：`INFO: Uvicorn running on http://0.0.0.0:8000`
- 确认服务绑定到 `0.0.0.0` 而不是 `127.0.0.1`

### 步骤2：确保前端服务正确启动

```powershell
# 运行前端启动脚本
3-启动前端服务.bat
```

**检查要点：**
- 确认 Vite 显示：`Network: http://192.168.x.x:5173` 或类似的外网地址
- 确认 `vite.config.js` 中设置了 `host: true`

### 步骤3：配置防火墙

**Windows 防火墙：**
1. 打开"Windows Defender 防火墙"
2. 点击"高级设置"
3. 添加入站规则：
   - 端口：8000（后端）
   - 端口：5173（前端，如果使用固定端口）
   - 协议：TCP
   - 操作：允许连接

**服务器防火墙（如果使用云服务器）：**
- 阿里云/腾讯云：在安全组中开放端口 8000 和 5173
- AWS：在安全组中开放端口 8000 和 5173

### 步骤4：验证配置

1. **检查后端服务：**
   - 在浏览器中访问：`http://你的IP:8000/docs`
   - 应该能看到 Swagger API 文档

2. **检查前端服务：**
   - 在浏览器中访问：`http://你的IP:5173`
   - 打开浏览器开发者工具（F12）
   - 查看 Console，应该看到：`API Base URL: http://你的IP:8000`

3. **测试API连接：**
   - 访问 Dashboard 页面
   - 查看浏览器 Network 标签
   - 检查 API 请求是否成功

## 🔧 故障排查

### 问题1：仍然显示"加载数据失败"

**检查清单：**
1. ✅ 后端服务是否启动？
   - 访问 `http://你的IP:8000/docs` 看是否能打开

2. ✅ 后端是否绑定到 0.0.0.0？
   - 检查启动日志，应该显示 `http://0.0.0.0:8000`

3. ✅ 防火墙是否开放端口？
   - 测试：`telnet 你的IP 8000` 或使用在线端口检测工具

4. ✅ 前端API地址是否正确？
   - 打开浏览器开发者工具（F12）
   - 查看 Console，检查 `API Base URL` 是否正确
   - 查看 Network 标签，检查请求的URL

5. ✅ CORS配置是否正确？
   - 后端 `main.py` 中已配置 `allow_origins=["*"]`

### 问题2：API请求返回 CORS 错误

**解决方案：**
后端已配置 CORS，如果仍有问题，检查：
1. 后端 `main.py` 中的 CORS 配置：
   ```python
   allow_origins=["*"],  # 生产环境应指定具体域名
   ```

2. 如果使用具体域名，修改为：
   ```python
   allow_origins=["http://你的IP:5173", "http://你的域名:5173"],
   ```

### 问题3：端口无法访问

**检查清单：**
1. 防火墙是否开放端口？
2. 服务器安全组是否开放端口？
3. 后端服务是否绑定到 0.0.0.0？
4. 端口是否被其他程序占用？

**测试方法：**
```powershell
# 在服务器上测试端口是否监听
netstat -ano | findstr ":8000"

# 从外网测试端口是否开放
# 使用在线工具：https://tool.chinaz.com/port
```

## 📝 配置示例

### 场景1：使用IP地址访问

**服务器IP：** `47.114.103.200`

**后端启动：**
```batch
uvicorn main:app --reload --port 8000 --host 0.0.0.0
```
后端地址：`http://47.114.103.200:8000`

**前端启动：**
```batch
npm run dev
```
前端地址：`http://47.114.103.200:5173`

**前端API自动配置：**
- 访问 `http://47.114.103.200:5173` 时
- 前端自动使用 `http://47.114.103.200:8000` 作为后端地址

### 场景2：使用域名访问

**域名：** `zhixueban.example.com`

**后端启动：**
```batch
uvicorn main:app --reload --port 8000 --host 0.0.0.0
```
后端地址：`http://zhixueban.example.com:8000`

**前端启动：**
```batch
npm run dev
```
前端地址：`http://zhixueban.example.com:5173`

**前端API自动配置：**
- 访问 `http://zhixueban.example.com:5173` 时
- 前端自动使用 `http://zhixueban.example.com:8000` 作为后端地址

## 🔒 安全建议

### 生产环境配置

1. **限制CORS来源：**
   ```python
   # backend/main.py
   allow_origins=[
       "http://你的域名:5173",
       "https://你的域名",  # 如果使用HTTPS
   ],
   ```

2. **使用HTTPS：**
   - 配置SSL证书
   - 使用Nginx反向代理
   - 配置HTTPS端口

3. **限制访问IP：**
   - 在防火墙中限制访问来源
   - 使用白名单机制

4. **API密钥保护：**
   - 确保 `.env` 文件不被提交到Git
   - 使用环境变量管理敏感信息

## ✅ 验证清单

部署完成后，请验证：

- [ ] 后端服务启动成功，绑定到 0.0.0.0
- [ ] 防火墙开放端口 8000 和 5173
- [ ] 可以从外网访问 `http://你的IP:8000/docs`
- [ ] 可以从外网访问 `http://你的IP:5173`
- [ ] 浏览器Console显示正确的API地址
- [ ] Dashboard页面能正常加载数据
- [ ] API请求成功，无CORS错误

## 📞 测试步骤

1. **测试后端：**
   ```
   访问：http://你的IP:8000/docs
   应该看到：Swagger API 文档
   ```

2. **测试前端：**
   ```
   访问：http://你的IP:5173
   打开开发者工具（F12）
   查看Console：应该看到 "API Base URL: http://你的IP:8000"
   ```

3. **测试API连接：**
   ```
   访问：http://你的IP:5173/dashboard
   查看Network标签：API请求应该成功（状态码200）
   ```

## 💡 提示

1. **开发环境**：使用 `localhost` 或 `127.0.0.1`，API自动使用本地地址
2. **生产环境**：使用外网IP或域名，API自动使用对应的后端地址
3. **调试**：打开浏览器开发者工具，查看Console和Network标签，检查API请求和响应

---

**如果仍有问题，请检查：**
1. 后端服务是否正常运行
2. 防火墙配置是否正确
3. 浏览器Console中的错误信息
4. Network标签中的请求详情


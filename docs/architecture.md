# 智学伴系统架构文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (React)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 用户界面  │  │ 管理后台  │  │ AI聊天   │  │ 学习计划  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTP/HTTPS
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                      API网关层 (FastAPI)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 认证路由  │  │ AI路由    │  │ 文件路由  │  │ 管理路由  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                      业务逻辑层 (Services)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ AI服务    │  │ Prompt服务│ │ 认证服务  │  │ 管理服务  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                      数据访问层 (Repositories)                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 用户Repo  │  │ PromptRepo│ │ 模型Repo  │  │ 测验Repo  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                        数据层 (SQLAlchemy)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 用户表    │  │ Prompt表  │  │ 模型配置表│  │ 测验表    │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 数据流程

### 1. 文件上传 → 学习计划生成

```
用户上传文件
    ↓
文件解析服务 (file_parser.py)
    ↓
提取文本内容
    ↓
AI服务调用 (ai_service.py)
    ↓
模型注册表 (model_registry.py)
    ↓
调用AI模型（支持fallback）
    ↓
文本清理 (markdown_sanitizer.py)
    ↓
生成学习计划
    ↓
保存到数据库
    ↓
返回给前端
```

### 2. AI问答流程

```
用户输入问题
    ↓
前端发送请求到 /api/v1/ai/ask
    ↓
AI路由 (routers/ai.py)
    ↓
AI服务 (services/ai_service.py)
    ↓
获取系统Prompt (prompt_service.py)
    ↓
构建消息列表
    ↓
模型注册表调用 (model_registry.py)
    ↓
Fallback策略（失败自动切换）
    ↓
文本清理（移除模型签名）
    ↓
返回响应
```

### 3. 管理后台配置流程

```
管理员登录
    ↓
访问管理后台
    ↓
配置模型（添加API密钥等）
    ↓
保存到数据库 (model_configs表)
    ↓
加密存储API密钥
    ↓
重新加载模型注册表
    ↓
立即生效（无需重启）
```

## 核心模块说明

### 1. 模型注册表 (model_registry.py)

- 统一管理各AI提供商的调用方法
- 支持优先级和fallback策略
- 从数据库动态加载配置
- 支持缓存和热更新

### 2. Prompt服务 (prompt_service.py)

- Prompt版本管理
- 缓存机制（5分钟TTL）
- 自动版本号递增
- 支持启用/禁用版本

### 3. AI服务 (ai_service.py)

- 统一AI调用接口
- 自动添加系统Prompt
- 文本清理（移除模型签名）
- 错误处理和日志记录

### 4. 安全模块 (core/security.py)

- JWT token生成和验证
- 密码加密（bcrypt）
- API密钥加密存储（Fernet）
- 角色权限检查

## 数据库设计

### 主要表结构

1. **users** - 用户表
   - id, email, name, hashed_password, role, created_at

2. **prompts** - Prompt表
   - id, name, version, content, description, enabled, author, created_at, updated_at

3. **model_configs** - 模型配置表
   - id, provider_name, api_key(加密), base_url, priority, enabled, params, created_at, updated_at

4. **quizzes** - 测验表
   - id, user_id, topic, questions, answers, score, created_at

5. **study_plans** - 学习计划表
   - id, user_id, content, created_at

## 安全机制

1. **JWT认证**：所有API请求需要JWT token
2. **角色权限**：管理员路由需要admin角色
3. **密钥加密**：API密钥使用Fernet加密存储
4. **密码加密**：使用bcrypt加密用户密码
5. **CORS配置**：生产环境应限制允许的域名

## 部署建议

### 开发环境
- SQLite数据库
- 单机部署
- 热重载启用

### 生产环境
- MySQL/PostgreSQL数据库
- Docker容器化部署
- Nginx反向代理
- Redis缓存（可选）
- 日志收集和监控

